@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions
@using MichaelKjellander.Models.Wordpress
@using MichaelKjellander.SharedUtils
@using MichaelKjellander.Components.Icons
@using MichaelKjellander.SharedUtils.Routes
@using MichaelKjellander.Components.Modals
@using MichaelKjellander.Models.ComponentModels
@using MichaelKjellander.SharedUtils.Components

@if (Post != null)
{
    <article class="border border-gray-200" @ref=_containerRef>
        <ImageGalleryModal Container="_containerRef"/>
        @*@if (_imageClasses.Count > 0)
        {
            <Modal ClickableClasses="_imageClasses">
                <div>test</div>
            </Modal>
        }*@
        @if (@Post.FeaturedImage!.IsSet)
        {
            <img src="@Post.FeaturedImage.FullUrl"/>
            @*<Modal ShowCallbacker="_showModalCallbacker">
                <img src="@Post.FeaturedImage.FullUrl"/>
            </Modal>
            <img class="cursor-pointer" src="@Post.FeaturedImage.ThumbnailUrl" @onclick="OnImageClick"/>*@
        }
        <div class="bg-white sg-post sg-post-padding">
            @if (@Post.Category!.Type == CategoryType.Game)
            {
                <span class="italic">@Post.Category!.Name</span>
                <div class="h-2"></div>
            }
            @if (IsSingle)
            {
                <h1 class="sg-post-title">@((MarkupString)@Post.Title!)</h1>
            }
            else
            {
                <a href="@PageRoutes.Post(Post.Slug!)">
                    <h3 class="sg-post-title">@((MarkupString)@Post.Title!)</h3>
                </a>
            }
            @if (@Post.Category!.Type == CategoryType.GameReview)
            {
                <div class="h-2"></div>
                <p class="italic">Recension</p>
                <p class="text-sm">Testat på: @String.Join(", ", Post.MetaPlatforms!)</p>
            }
            <div class="sg-post-content">
                @((MarkupString)Post.Content!)
            </div>
            @if (Post.Category!.Type == CategoryType.GameReview)
            {
                <div class="border border-black border-dashed px-8 py-6">
                    <div class="font-bold">@Post.RatingText</div>
                    @if (Post.MetaPlayAlso != null)
                    {
                        <div class="h-2"></div>
                        <div class="border-b"></div>
                        <div class="h-2"></div>
                    }
                    @if (Post.MetaPlayAlso != null)
                    {
                        <div class="text-sm">Spela även @Post.MetaPlayAlso</div>
                    }
                </div>
            }
        </div>
        <div class="sg-post-footer sg-footer-padding">
            <div class="sg-break-together">
                <IconCalendarMonth/>
                <span class="mr-4">@DateUtil.FormatDate(Post.Date)</span>
            </div>
            <div class="sg-break-together">
                <IconFolder/>
                <span class="mr-4">@Post.Category.Name</span>
            </div>
            @if (Post.MetaPlatforms!.Count > 0)
            {
                <div class="sg-break-together">
                    <IconDeviceGamepad2/>
                    @FormatPlattform(0)
                </div>
                @for (int i = 1; i < Post.MetaPlatforms!.Count; i++)
                {
                    <div class="sg-break-together">
                        @FormatPlattform(i)
                    </div>
                }
            }
        </div>
    </article>
}


@code {
    [Parameter] [Required] public WpPost? Post { get; set; }
    [Parameter] [Required] public bool IsSingle { get; set; }

    private ElementReference _containerRef;
    //private IList<Image> _images = [];
    private ComponentCallbacker? _showModalCallbacker;

    protected override void OnInitialized()
    {
        _showModalCallbacker ??= new ComponentCallbacker();
    }

    protected override void OnParametersSet()
    {
        IdentifyImages();
    }

    private void IdentifyImages()
    {
        /*Regex regex = new Regex("<img.*class=\"(.*?)\".*?src=\"(.*?)\".*?>");
        MatchCollection matches = regex.Matches(Post!.Content!);
        List<Image> imageClasses = [];
        for(int i = 0; i < matches.Count; i++)
        {
            Match match = matches[i];
            string className = match.Groups[1].ToString();
            string source = match.Groups[2].ToString();
            Console.WriteLine("*** c="+className+", s="+source);
            imageClasses.Add(new(className, source));
        }
        this._images = imageClasses;*/
    }
    
    private void OnImageClick()
    {
        _showModalCallbacker!.Action!();
    }

    private string FormatPlattform(int index)
    {
        string formattedTagName = Post!.MetaPlatforms![index];
        bool isLast = Post!.MetaPlatforms!.Count == index + 1;
        if (!isLast)
        {
            formattedTagName += ", ";
        }

        return formattedTagName;
    }

}