@page "/"
@page "/senaste/{CurrentPage:int}"
@using MichaelKjellander.Models.Wordpress
@inject IHttpClientFactory ClientFactory
@using MichaelKjellander.Services
@using MichaelKjellander.SharedUtils
@using MichaelKjellander.SharedUtils.Api
@using MichaelKjellander.Components.Boxes
@inject Microsoft.Extensions.Options.IOptions<AppConfig> Options
@rendermode InteractiveServer
@inject ILogger<PaginationBox> Logger
@inject JsService JsService

<PageTitle>
    @(CurrentPage > 1 ? $"Michael Kjellander - Senaste inläggen - Sida {CurrentPage}" : "Michael Kjellanders hemsida")
</PageTitle>

@if (CurrentPage == null)
{
    <div class="bg-white sg-title-section">
        @*Borders ruins the padding*@
        <div class="sg-title-section-side hidden sm:block"></div>
        <div class="py-10 px-10 sm:px-20">
            <h1 class="text-2xl font-bold">Välkommen till Michael Kjellanders hemsida!</h1>
            <div class="h-4"></div>
            <h2 class="text-slate-500">
                Här postar jag tv-spelrecensioner och annat. Webbplatsen är byggd med Blazor med API-koppling mot min tidigare Wordpress-sajt. 
                Mode: @Options.Value.AppEnvironment, url: @Options.Value.SiteUrl
            </h2>
        </div>
    </div>
}

@if (_posts != null)
{
    @foreach (WpPost post in _posts)
    {
        <PostBox Post="post"/>
    }
}

<PaginationBox paginationData="@_pagination" UrlPrefix="/senaste" FirstUrlPrefix="/"/>


@code {
    [Parameter] public int? CurrentPage { get; set; }
    private ICollection<WpPost>? _posts;
    private PaginationData? _pagination;

    protected override async Task OnInitializedAsync()
    {
        InternalApiService service = new InternalApiService(ClientFactory.CreateClient(), Options);
        ApiResponse<WpPost> postData = await service.FetchPosts(pageNumber: CurrentPage ?? 1);
        this._posts = postData.Items;
        this._pagination = postData.PaginationData;
    }
    
    protected override void OnAfterRender(bool firstRender)
    {
        JsService.ScrollToTop();
    }
}
